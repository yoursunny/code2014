<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>How to specify server IP in HttpWebRequest - 你的阳光技术频道 www.65536.cn</title>
<meta name="keywords" content="System.Net.HttpWebRequest,ServicePoint"/>
<link rel="alternate" type="application/atom+xml" href="http://feed.feedsky.com/65536" />
<link rel="stylesheet" type="text/css" href="/images/9/" />
<script type="text/javascript" src="/lib/9.js?prettify"></script>
</head><body>

<div class="header">
<h2><a href="http://yoursunny.com/">你的阳光</a></h2>
<ul>
<li><a href="http://m.yoursunny.com/"><span>个人</span></a></li>
<li><a href="http://study.yoursunny.com/"><span>学习</span></a></li>
<li><a href="http://www.65536.cn/"><span>技术</span></a></li>
<li><a href="http://www.65536.cn/work/"><span>作品</span></a></li>
</ul>
<ol>
<li><a href="http://yoursunny.com/">你的阳光</a></li>
<li><a href="/">技术频道</a></li>
<li><a href="../">文章</a></li>
<li><span>How to specify server IP in HttpWebRequest</span></li>
</ol>
</div>

<div class="content">

<div class="p"><div class="p-wrap">
<h1 class="tit">How to specify server IP in HttpWebRequest</h1>
<div id="posts" class="p-body headers">

<p class="byline">sunny boy, 2009-01-01</p>


<p class="indent">I was writing an <a href="http://www.65536.cn/work/2008/hProxyN/">HTTP proxy</a> during last weeks. I need to address the origin server with a custom IP address, but I should keep the "Host" header.</p>
<p class="indent">I googled about "HttpWebRequest set server IP", "WebRequest modify Host", etc. I read through several posts, and realized:</p>
<ul>
<li>When HttpWebRequest is created, the "Host" header is automatically set to the "host:port" portion of the Uri.</li>
<li>Attempt to modify HttpWebRequest.Headers["Host"] will throw an exception.</li>
<li>The server IP address of the HTTP Request is determined by the host portion of the Uri, and is automatically resolved against the DNS server.</li>
<li>When HttpWebRequest.Proxy is set to use a proxy, the server IP address is determined by resolving the host of Proxy property. I can set the origin server as the proxy, this is called "Proxy hack".</li>
<li>When using a proxy, the HTTP Request-Line looks like "GET http://host/ HTTP/1.1" rather than "GET / HTTP/1.1". Every HTTP/1.1 compliant origin server should accept this, but firewalls may think it's a "proxy request" and block it, and some non-compliant servers does not accept it.</li>
</ul>
<h3>SOLUTION</h3>
<p class="indent">My purpose is: <b>make HttpWebRequest send its request to a custom IP address, but leave the Request-Line as "GET / HTTP/1.1"</b>.</p>
<p class="indent">After hours of <a href="http://www.red-gate.com/products/reflector/" rel="external" onclick="c('HttpWebRequest-IP.Reflector')">Reflector</a>, I found the solution:</p>
<pre class="prettyprint lang-cs">
HttpWebRequest req = (HttpWebRequest)WebRequest.Create("http://blogs.msdn.com");//url and Host header
FieldInfo field_ServicePoint_ProxyServicePoint = (typeof(ServicePoint))
    .GetField("m_ProxyServicePoint", BindingFlags.NonPublic | BindingFlags.Instance);
req.Proxy = new WebProxy("www.google.com:80");//server IP and port
field_ServicePoint_ProxyServicePoint.SetValue(req.ServicePoint, false);
HttpWebResponse resp = (HttpWebResponse)req.GetResponse();
</pre>
<p class="indent">When the above code is executed, I can see the following request in Wireshark:</p>
<pre>
GET / HTTP/1.1
Host: blogs.msdn.com
Connection: Keep-Alive
</pre>
<p class="indent">And, the request is sent to 64.233.189.99:80, a www.google.com server.</p>
<p><a href="HttpWebRequest-IP.zip" onclick="c('HttpWebRequest-IP.zip')">DOWNLOAD: C# code &amp; Wireshark capture</a></p>
<h3>BEHIND THE SCENES</h3>
<p class="indent"><i>ServicePoint</i> class provides connection management for HTTP connections. A ServicePoint instance is created for each "host:port" combination, and reused across several requests. <code class="prettyprint lang-cs">ServicePoint.m_ProxyServicePoint</code> determines whether this ServicePoint connects to a proxy. When <i>m_ProxyServicePoint</i> is set to false, HttpWebRequest don't think it's a proxy, so the Request-Line becomes "GET / HTTP/1.1".</p>
<p class="indent">However, <i>m_ProxyServicePoint</i> is a private property of ServicePoint, so I have to use <i>Reflection</i> to change it.</p>
<p>Author: <a href="http://www.facebook.com/profile.php?id=721293826" rel="me external" onclick="c('/m/my.facebook')">sunny boy</a></p>
<p>Note: to help international users, this article is written in English.</p>

</div></div></div>

</div>

<div class="footer">
<p class="copyright">&copy;2006-2009 yoursunny.com, CreativeCommons BY-NC 3.0</p>
<ul class="links">
<li><a href="http://yoursunny.com/m/about.htm">关于本站</a></li>
<li><a href="http://yoursunny.com/m/contact.htm">联系方式</a></li>
<li><a href="http://yoursunny.com/m/sitemap.htm">网站地图</a></li>
</ul>
</div>

</body></html>
